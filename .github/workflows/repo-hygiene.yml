name: repo-hygiene
on:
  pull_request:
  workflow_dispatch:
jobs:
  forbid-venv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if virtualenv artifacts are tracked
        run: |
          set -euo pipefail
          bad=$(git ls-files | grep -E '(^\\.venv|/\\.venv|^venv|/site-packages/|\\.dist-info/)' || true)
          if [ -n "$bad" ]; then
            echo "Tracked virtualenv artifacts detected:" >&2
            echo "$bad" >&2
            exit 1
          fi

  forbid-hidden-unicode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if hidden/bidirectional Unicode chars exist
        run: |
          set -euo pipefail
          # Zero-width characters: BOM, ZWJ, ZWNJ, LRM, RLM
          # Bidirectional controls: LRO, RLO, LRE, RLE, PDF, LRI, RLI, FSI, PDI
          # Hidden characters: LRM, RLM, ZWJ, ZWNJ
          if git grep -nI -P '[\x{200B}-\x{200D}\x{FEFF}\x{202A}-\x{202E}\x{2066}-\x{2069}\x{200E}\x{200F}]' -- .; then
            echo "Hidden/bidirectional Unicode detected"
            exit 1
          fi

  forbid-secrets-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail if secret-like tokens exist in scripts/
        run: |
          set -euo pipefail
          # Focus on scripts/ to avoid false positives in tests.
          if git grep -nI -E 's[k]-[A-Za-z0-9]{20,}|g[h]p_[A-Za-z0-9]{20,}|A[K]IA[0-9A-Z]{16}|-----BEGIN [A-Z ]*PRIVATE KEY-----|xox[baprs]-[A-Za-z0-9-]{10,}' -- scripts; then
            echo "Secret-like token detected in scripts/" >&2
            exit 1
          fi
